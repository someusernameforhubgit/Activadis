<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/header.css">
    <script>
        window.headerConfig = {
            title: { subtitle: "Gebruiker Details" },
            navLeft: [
                { href: "/", icon: "fas fa-home", label: "Home" },
                { href: "/beheerder", label: "Beheerder", active: true },
                { href: "/profiel", label: "Profiel" }
            ]
        };
    </script>
    <script src="/util/header.js"></script>
    <script src="/util/avatar.js"></script>
    <script src="/beheerder/verifyAdmin.js"></script>
    <title>Activadis - Gebruiker Details</title>
</head>

<body>
    <header></header>
    <section id="mainContainer">
        <aside id="sidebar">
            <h1>Navigatie</h1>
            <ul>
                <li><a href="/beheerder/">Dashboard</a></li>
                <li><a href="/beheerder/gebruikers">Gebruikers</a></li>
                <li><a href="/beheerder/activiteiten">Activiteiten</a></li>
                <li><a href="/beheerder/rollen">Rollen</a></li>
            </ul>
        </aside>
        <main id="mainContent">
            <div class="heading split-row">
                <h2 id="page-title">Gebruiker Details</h2>
                <div>
                    <button class="btn btn-secondary" onclick="goBack()">
                        <i class="fas fa-arrow-left"></i> Terug
                    </button>
                    <button class="btn btn-primary" id="edit-btn" onclick="editUser()">
                        <i class="fas fa-edit"></i> Bewerken
                    </button>
                </div>
            </div>

            <div id="user-details" class="content-section">
                <div id="loading" class="loading-container">
                    <div class="loading-spinner"></div>
                    <p>Laden van gebruiker gegevens...</p>
                </div>
                <div id="user-content" style="display: none;">
                    <div class="user-header">
                        <div class="user-avatar xlarge" id="user-avatar">
                            ?
                        </div>
                        <div class="user-summary">
                            <h3 id="user-name-title"></h3>
                            <div class="user-meta">
                                <span class="meta-item"><i class="fas fa-envelope"></i> <span
                                        id="user-email-meta"></span></span>
                            </div>
                        </div>
                    </div>

                    <div class="user-details-grid">
                        <div class="details-section">
                            <h4>Persoonlijke gegevens</h4>
                            <div class="view-item">
                                <label>Volledige naam:</label>
                                <div class="value" id="user-fullname"></div>
                            </div>
                            <div class="view-item">
                                <label>Voornaam:</label>
                                <div class="value" id="user-firstname"></div>
                            </div>
                            <div class="view-item">
                                <label>Achternaam:</label>
                                <div class="value" id="user-lastname"></div>
                            </div>
                        </div>

                        <div class="details-section">
                            <h4>Account informatie</h4>
                            <div class="view-item">
                                <label>E-mailadres:</label>
                                <div class="value email" id="user-email"></div>
                            </div>
                            <div class="view-item">
                                <label>Functie profiel:</label>
                                <div class="value" id="user-role"></div>
                            </div>
                            <div class="view-item">
                                <label>Is beheerder:</label>
                                <div class="value" id="user-status">Actief</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="error-message" style="display: none;">
                    <div class="error-container">
                        <i class="fas fa-exclamation-triangle"></i>
                        <h3>Fout bij laden</h3>
                        <p id="error-text">Er is een fout opgetreden bij het laden van de gebruiker.</p>
                        <div class="error-actions">
                            <button class="btn btn-primary" onclick="retryLoad()">Opnieuw proberen</button>
                            <button class="btn btn-secondary" onclick="goBack()">Terug naar overzicht</button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </section>

    <style>
        .loading-container {
            text-align: center;
            padding: 60px 20px;
        }

        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .error-container {
            text-align: center;
            padding: 40px 20px;
            color: #721c24;
        }

        .error-container i {
            font-size: 3rem;
            color: #dc3545;
            margin-bottom: 20px;
        }

        .error-container h3 {
            margin-bottom: 10px;
            color: #721c24;
        }

        .error-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        /* Avatar styles now handled by global CSS */

        .user-details-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }

        .details-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }

        .details-section h4 {
            margin: 0 0 20px 0;
            color: #333;
            font-size: 1.2rem;
            padding-bottom: 10px;
            border-bottom: 1px solid #dee2e6;
        }

        .view-item {
            display: flex;
            flex-direction: column;
            margin-bottom: 15px;
        }

        .view-item:last-child {
            margin-bottom: 0;
        }

        .view-item label {
            font-weight: bold;
            color: #555;
            margin-bottom: 5px;
            font-size: 0.9rem;
        }

        .view-item .value {
            color: #333;
            font-size: 1rem;
        }

        .value.badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: bold;
            width: fit-content;
        }

        .badge {
            background-color: rgba(128, 128, 128, 0.1);
        }

        @media (max-width: 1024px) {
            .user-details-grid {
                grid-template-columns: 1fr;
                gap: 20px;
            }
        }

        @media (max-width: 768px) {
            /* Avatar responsive styles now handled by global CSS */

            .error-actions {
                flex-direction: column;
                align-items: center;
            }
        }
    </style>

    <script>
        const token = sessionStorage.getItem("JWT");
        const API_URL = '/api/gebruiker';
        let currentUser = null;
        let retryCount = 0;
        const MAX_RETRIES = 3;

        // Helper functions
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function getUserIdFromUrl() {
            const m = window.location.pathname.match(/\/beheerder\/gebruikers\/(\d+)/);
            if (m) return parseInt(m[1]);
            const urlParams = new URLSearchParams(window.location.search);
            const id = urlParams.get('id');
            return id ? parseInt(id) : null;
        }

        function goBack() {
            if (document.referrer && document.referrer.includes('/beheerder/')) {
                window.history.back();
            } else {
                window.location.href = '/beheerder/gebruikers';
            }
        }

        function editUser() {
            if (currentUser) {
                window.location.href = `/beheerder/gebruikers/${currentUser.id}/edit`;
            }
        }

        // Error handling
        function retryLoad() {
            const userId = getUserIdFromUrl();
            if (userId && retryCount < MAX_RETRIES) {
                retryCount++;
                document.getElementById('error-message').style.display = 'none';
                document.getElementById('loading').style.display = 'block';
                loadUser(userId);
            } else {
                showError('Maximaal aantal pogingen bereikt. Probeer later opnieuw.');
            }
        }

        function showError(message = 'Er is een fout opgetreden bij het laden van de gebruiker.') {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('user-content').style.display = 'none';
            document.getElementById('error-text').textContent = message;
            document.getElementById('error-message').style.display = 'block';
        }

        document.addEventListener('DOMContentLoaded', function () {
            const userId = getUserIdFromUrl();
            if (userId) {
                loadUser(userId);
            } else {
                showError('Geen gebruiker ID gevonden.');
            }
        });

        async function loadUser(id) {
            if (!id) {
                showError('Geen geldig gebruiker ID gevonden.');
                return;
            }

            try {
                const response = await fetch(`${API_URL}?id=${id}&token=${token}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    if (response.status === 401) {
                        showError('U bent niet geautoriseerd. Log opnieuw in.');
                        setTimeout(() => window.location.href = '/login', 2000);
                        return;
                    } else if (response.status === 404) {
                        showError('Gebruiker niet gevonden.');
                        return;
                    } else {
                        throw new Error(`HTTP ${response.status}`);
                    }
                }

                const user = await response.json();

                if (!user || (Array.isArray(user) && user.length === 0)) {
                    showError('Gebruiker niet gevonden.');
                    return;
                }

                // Handle both single object and array responses
                const userData = Array.isArray(user) ?
                    user.find(usr => usr.id == id) : user;

                if (userData) {
                    currentUser = userData;
                    displayUser(userData);
                } else {
                    showError('Gebruiker niet gevonden.');
                }

            } catch (error) {
                console.error('Error loading user:', error);
                const errorMessage = retryCount < MAX_RETRIES ?
                    'Fout bij laden van gebruiker. Probeer het opnieuw.' :
                    'Kan gebruiker niet laden na meerdere pogingen.';
                showError(errorMessage);
            }
        }

        async function displayUser(user) {
            try {
                // Validate user data
                if (!user.email) {
                    throw new Error('Invalid user data: missing email');
                }

                // Create display names
                const firstName = escapeHtml(user.firstname) || '';
                const lastName = escapeHtml(user.lastname) || '';
                const fullName = `${firstName} ${lastName}`.trim();
                const displayName = fullName || user.email;

                // Update page title
                document.getElementById('page-title').textContent = `Gebruiker: ${displayName}`;
                document.title = `Activadis - ${displayName}`;

                // Header section
                document.getElementById('user-name-title').textContent = displayName;
                document.getElementById('user-email-meta').textContent = user.email;

                // Role meta with icon
                console.log('User data:', user);

                let roleName = 'Geen rol';

                if (user.role && user.role !== 0 && user.role !== '0') {
                    try {
                        const response = await fetch(`/api/role?id=${user.role}&token=${token}`, {
                            method: 'GET',
                            headers: {
                                'Content-Type': 'application/json'
                            }
                        });

                        if (response.ok) {
                            const roleData = await response.json();
                            console.log('Role data:', roleData);
                            roleName = roleData.name;

                            const roleElement = document.getElementById('user-role');
                            roleElement.textContent = roleData.name;
                        } else {
                            console.error('Failed to fetch role data:', response.status);
                        }
                    } catch (error) {
                        console.error('Error fetching role:', error);
                    }
                }

                // Details sections
                document.getElementById('user-fullname').textContent = fullName || 'Niet ingesteld';
                document.getElementById('user-firstname').textContent = firstName || 'Niet ingesteld';
                document.getElementById('user-lastname').textContent = lastName || 'Niet ingesteld';
                document.getElementById('user-email').textContent = user.email;

                // Status (always active for now)
                const statusElement = document.getElementById('user-status');
                if (user.isAdmin == 1) {
                    statusElement.textContent = 'Ja';
                } else {
                    statusElement.textContent = 'Nee';
                }

                // Update avatar with user initials
                const avatarElement = document.getElementById('user-avatar');
                updateAvatarElement(avatarElement, user);

                // Show content and hide loading
                document.getElementById('loading').style.display = 'none';
                document.getElementById('user-content').style.display = 'block';

            } catch (error) {
                console.error('Error displaying user:', error);
                showError('Fout bij het weergeven van de gebruiker gegevens.');
            }
        }
    </script>
</body>

</html>