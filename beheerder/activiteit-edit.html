<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/header.css">
    <script src="/beheerder/verifyAdmin.js"></script>
    <title>Activadis - Activiteit Bewerken</title>
</head>
<body>
<header>
    <div class="container">
        <div class="left">
            <p><b><span class="accent">Acti</span>vadis</b>: Activiteit Bewerken</p>
            <nav>
                <div class="nav-left">
                    <a href="/"><i class="fas fa-home"></i>Home</a>
                    <a href="/beheerder">Beheerder</a>
                </div>
                <div>
                    <a class="login" href="/login"><i class="fas fa-sign-in-alt"></i>Login</a>
                    <p class="logout name">NAME HERE</p>
                    <a class="logout" onclick="logout()">Logout</a>
                </div>
            </nav>
        </div>
    </div>
</header>
    <section id="mainContainer">
        <aside id="sidebar">
            <h1>Navigatie</h1>
            <ul>
                <li><a href="/beheerder/">Dashboard</a></li>
                <li><a href="/beheerder/gebruikers.html">Gebruikers</a></li>
                <li><a href="/beheerder/activiteiten.html">Activiteiten</a></li>
            </ul>
        </aside>
        <main id="mainContent">
            <div class="heading split-row">
                <h2 id="page-title">Nieuwe Activiteit</h2>
                <button class="btn btn-secondary" onclick="goBack()">
                    <i class="fas fa-arrow-left"></i> Terug
                </button>
            </div>

            <div id="activity-form-section" class="content-section">
                <div id="loading">
                    <p>Laden...</p>
                </div>
                <form id="activity-form" style="display: none;">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="activity-naam">Naam *</label>
                            <input type="text" id="activity-naam" required>
                        </div>
                        <div class="form-group">
                            <label for="activity-locatie">Locatie *</label>
                            <input type="text" id="activity-locatie" required>
                        </div>
                        <div class="form-group checkbox">
                            <label for="activity-eten">Inclusief Eten *</label>
                            <input type="checkbox" id="activity-eten">
                        </div>
                        <div class="form-group full-width">
                            <label for="activity-omschrijving">Omschrijving *</label>
                            <textarea id="activity-omschrijving" required rows="4"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="activity-begin">Begin datum/tijd *</label>
                            <input type="datetime-local" id="activity-begin" required>
                        </div>
                        <div class="form-group">
                            <label for="activity-eind">Eind datum/tijd *</label>
                            <input type="datetime-local" id="activity-eind" required>
                        </div>
                        <div class="form-group">
                            <label for="activity-kost">Kosten (â‚¬) *</label>
                            <input type="number" id="activity-kost" step="0.01" required>
                        </div>
                        <div class="form-group">
                            <label for="activity-max">Maximum deelnemers *</label>
                            <input type="number" id="activity-max" required>
                        </div>
                        <div class="form-group">
                            <label for="activity-min">Minimum deelnemers *</label>
                            <input type="number" id="activity-min" required>
                        </div>
                        <div class="form-group full-width">
                            <label for="activity-afbeelding">Afbeelding URL *</label>
                            <input type="url" id="activity-afbeelding" required>
                        </div>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="goBack()">Annuleren</button>
                        <button type="submit" class="btn btn-primary" id="submit-btn">Toevoegen</button>
                    </div>
                </form>
                <div id="error-message" style="display: none;">
                    <p class="text-danger">Fout bij het laden van de activiteit.</p>
                    <button class="btn btn-secondary" onclick="goBack()">Terug naar overzicht</button>
                </div>
            </div>
        </main>
    </section>

    <style>
        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        .form-group.full-width {
            grid-column: span 2;
        }
        
        .form-group.checkbox {
            flex-direction: row;
            align-items: center;
            gap: 10px;
        }
        
        .form-group.checkbox input[type="checkbox"] {
            width: auto;
        }
        
        .form-group label {
            font-weight: bold;
            margin-bottom: 5px;
            color: #333;
        }
        
        .form-group.checkbox label {
            margin-bottom: 0;
        }
        
        .form-group input,
        .form-group textarea,
        .form-group select {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 2px rgba(0,123,255,.25);
        }
        
        .form-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }
        
        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .form-group.full-width {
                grid-column: span 1;
            }
        }
    </style>

    <script>
        const token = sessionStorage.getItem("JWT");
        const API_URL = '/api/activiteit';
        let currentActivity = null;
        let isEditMode = false;

        // Helper functions for text handling
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Get activity ID from URL parameters
        function getActivityIdFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('id');
        }

        // Go back to previous page or activities list
        function goBack() {
            if (document.referrer && document.referrer.includes('/beheerder/')) {
                window.history.back();
            } else {
                window.location.href = '/beheerder/activiteiten.html';
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            const activityId = getActivityIdFromUrl();
            if (activityId) {
                isEditMode = true;
                document.getElementById('page-title').textContent = 'Activiteit Bewerken';
                document.getElementById('submit-btn').textContent = 'Bijwerken';
                document.title = 'Activadis - Activiteit Bewerken';
                loadActivity(activityId);
            } else {
                // New activity mode
                isEditMode = false;
                document.getElementById('loading').style.display = 'none';
                document.getElementById('activity-form').style.display = 'block';
            }

            // Handle form submission
            document.getElementById('activity-form').addEventListener('submit', handleSubmit);
        });

        async function loadActivity(id) {
            try {
                const response = await fetch(`${API_URL}?id=${id}&token=${token}`);
                
                if (response.ok) {
                    const activities = await response.json();
                    // API returns array, find the specific activity
                    const activity = Array.isArray(activities) ? 
                        activities.find(act => act.id == id) : activities;
                    
                    if (activity) {
                        currentActivity = activity;
                        populateForm(activity);
                    } else {
                        showError();
                    }
                } else {
                    showError();
                }
            } catch (error) {
                console.error('Error loading activity:', error);
                showError();
            }
        }

        function populateForm(activity) {
            document.getElementById('activity-naam').value = activity.naam || '';
            document.getElementById('activity-locatie').value = activity.locatie || '';
            document.getElementById('activity-eten').checked = Boolean(activity.eten);
            document.getElementById('activity-omschrijving').value = activity.omschrijving || '';
            document.getElementById('activity-begin').value = activity.begin ? 
                new Date(activity.begin).toISOString().slice(0, 16) : '';
            document.getElementById('activity-eind').value = activity.eind ? 
                new Date(activity.eind).toISOString().slice(0, 16) : '';
            document.getElementById('activity-kost').value = activity.kost || '';
            document.getElementById('activity-max').value = activity.max || '';
            document.getElementById('activity-min').value = activity.min || '';
            document.getElementById('activity-afbeelding').value = activity.afbeelding || '';
            
            // Show form and hide loading
            document.getElementById('loading').style.display = 'none';
            document.getElementById('activity-form').style.display = 'block';
        }

        async function handleSubmit(e) {
            e.preventDefault();
            
            const formData = {
                naam: document.getElementById('activity-naam').value.trim(),
                locatie: document.getElementById('activity-locatie').value.trim(),
                eten: document.getElementById('activity-eten').checked ? 1 : 0,
                omschrijving: document.getElementById('activity-omschrijving').value.trim(),
                begin: document.getElementById('activity-begin').value,
                eind: document.getElementById('activity-eind').value,
                kost: parseFloat(document.getElementById('activity-kost').value),
                max: parseInt(document.getElementById('activity-max').value),
                min: parseInt(document.getElementById('activity-min').value),
                afbeelding: document.getElementById('activity-afbeelding').value.trim()
            };

            // Validate required fields
            for (const [key, value] of Object.entries(formData)) {
                if (!value && value !== 0) {
                    alert(`Vul het veld "${key}" in!`);
                    return;
                }
            }

            // Validate min <= max
            if (formData.min > formData.max) {
                alert('Minimum deelnemers kan niet groter zijn dan maximum deelnemers!');
                return;
            }

            // Validate dates
            const beginDate = new Date(formData.begin);
            const eindDate = new Date(formData.eind);
            if (beginDate >= eindDate) {
                alert('Begin datum moet voor eind datum liggen!');
                return;
            }

            if (isEditMode && currentActivity) {
                formData.id = currentActivity.id;
            }

            // Disable submit button to prevent double submission
            const submitBtn = document.getElementById('submit-btn');
            const originalText = submitBtn.textContent;
            submitBtn.disabled = true;
            submitBtn.textContent = 'Bezig...';

            try {
                const response = await fetch(`${API_URL}?token=${token}`, {
                    method: isEditMode ? 'PUT' : 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });

                if (response.ok) {
                    alert(isEditMode ? 'Activiteit bijgewerkt!' : 'Activiteit toegevoegd!');
                    
                    // Redirect to activities list
                    window.location.href = '/beheerder/activiteiten.html';
                } else {
                    const error = await response.text();
                    alert('Fout: ' + error);
                }
            } catch (error) {
                console.error('Error saving activity:', error);
                alert('Fout bij opslaan van activiteit');
            } finally {
                // Re-enable submit button
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
            }
        }

        function showError() {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('error-message').style.display = 'block';
        }
    </script>
</body>
</html>