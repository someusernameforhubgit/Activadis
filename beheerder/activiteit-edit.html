<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/header.css">
    <script src="/beheerder/verifyAdmin.js"></script>
    <title>Activadis - Activiteit Bewerken</title>
</head>
<body>
<header>
    <div class="container">
        <div class="left">
            <p><b><span class="accent">Acti</span>vadis</b>: Activiteit Bewerken</p>
            <nav>
                <div class="nav-left">
                    <a href="/"><i class="fas fa-home"></i>Home</a>
                    <a href="/beheerder">Beheerder</a>
                </div>
                <div>
                    <a class="login" href="/login"><i class="fas fa-sign-in-alt"></i>Login</a>
                    <p class="logout name"></p>
                    <a class="logout" onclick="logout()">Logout</a>
                </div>
            </nav>
        </div>
    </div>
</header>
    <section id="mainContainer">
        <aside id="sidebar">
            <h1>Navigatie</h1>
            <ul>
                <li><a href="/beheerder/">Dashboard</a></li>
                <li><a href="/beheerder/gebruikers">Gebruikers</a></li>
                <li><a href="/beheerder/activiteiten">Activiteiten</a></li>
            </ul>
        </aside>
        <main id="mainContent">
            <div class="heading split-row">
                <h2 id="page-title">Nieuwe Activiteit</h2>
                <button class="btn btn-secondary" onclick="goBack()">
                    <i class="fas fa-arrow-left"></i> Terug
                </button>
            </div>

            <div id="activity-form-section" class="content-section">
                <div id="loading" class="loading-container">
                    <div class="loading-spinner"></div>
                    <p>Laden...</p>
                </div>
                <form id="activity-form" style="display: none;">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="activity-naam">Naam *</label>
                            <input type="text" id="activity-naam" required maxlength="255" autocomplete="off">
                            <div class="field-error" id="naam-error"></div>
                        </div>
                        <div class="form-group">
                            <label for="activity-locatie">Locatie *</label>
                            <input type="text" id="activity-locatie" required maxlength="255" autocomplete="off">
                            <div class="field-error" id="locatie-error"></div>
                        </div>
                        <div class="form-group checkbox">
                            <label for="activity-eten">Inclusief Eten</label>
                            <input type="checkbox" id="activity-eten">
                        </div>
                        <div class="form-group full-width">
                            <label for="activity-omschrijving">Omschrijving *</label>
                            <textarea id="activity-omschrijving" required rows="4" maxlength="2000" placeholder="Beschrijf de activiteit in detail..."></textarea>
                            <small class="field-help">Maximaal 2000 karakters</small>
                            <div class="field-error" id="omschrijving-error"></div>
                        </div>
                        <div class="form-group">
                            <label for="activity-begin">Begin datum/tijd *</label>
                            <input type="datetime-local" id="activity-begin" required>
                            <div class="field-error" id="begin-error"></div>
                        </div>
                        <div class="form-group">
                            <label for="activity-eind">Eind datum/tijd *</label>
                            <input type="datetime-local" id="activity-eind" required>
                            <div class="field-error" id="eind-error"></div>
                        </div>
                        <div class="form-group">
                            <label for="activity-kost">Kosten (â‚¬)</label>
                            <input type="number" id="activity-kost" step="0.01" min="0" max="9999.99" placeholder="0 (laat leeg voor gratis)">
                            <div class="field-error" id="kost-error"></div>
                        </div>
                        <div class="form-group">
                            <label for="activity-max">Maximum deelnemers *</label>
                            <input type="number" id="activity-max" min="1" max="1000" required placeholder="10">
                            <div class="field-error" id="max-error"></div>
                        </div>
                        <div class="form-group">
                            <label for="activity-min">Minimum deelnemers *</label>
                            <input type="number" id="activity-min" min="1" max="1000" required placeholder="1">
                            <div class="field-error" id="min-error"></div>
                        </div>
                        <!-- <div class="form-group full-width">
                            <label for="activity-afbeelding">Afbeelding URL</label>
                            <input type="url" id="activity-afbeelding" maxlength="500" placeholder="https://voorbeeld.com/afbeelding.jpg">
                            <div class="field-error" id="afbeelding-error"></div>
                        </div> -->
                        <div class="form-group full-width">
                            <label for="activity-afbeelding">Afbeeldingen</label>
                            <div>
                                <input type="text" name="" id="activity-afbeeldingUrl" placeholder="Image URL">
                                <button type="button" class="btn btn-primary" id="add-afbeelding" onclick="addImage()">+</button>
                            </div>
                            <div id="activity-afbeeldingen">
                            </div>
                        </div>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="goBack()">Annuleren</button>
                        <button type="submit" class="btn btn-primary" id="submit-btn">Toevoegen</button>
                    </div>
                </form>
                <div id="error-message" style="display: none;">
                    <div class="error-container">
                        <i class="fas fa-exclamation-triangle"></i>
                        <h3>Fout bij laden</h3>
                        <p id="error-text">Er is een fout opgetreden bij het laden van de activiteit.</p>
                        <div class="error-actions">
                            <button class="btn btn-primary" onclick="retryLoad()">Opnieuw proberen</button>
                            <button class="btn btn-secondary" onclick="goBack()">Terug naar overzicht</button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </section>

    <style>
        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group.full-width {
            grid-column: span 2;
        }

        .form-group.checkbox {
            flex-direction: column;
            justify-content: center;
            gap: 10px;
        }

        .form-group.checkbox input[type="checkbox"] {
            width: fit-content;
        }

        .form-group label {
            font-weight: bold;
            margin-bottom: 5px;
            color: #333;
        }

        .form-group.checkbox label {
            margin-bottom: 0;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(0,123,255,.25);
        }

        .form-group input.error,
        .form-group textarea.error,
        .form-group select.error {
            border-color: #dc3545;
            box-shadow: 0 0 0 2px rgba(220,53,69,.25);
        }

        .field-error {
            color: #dc3545;
            font-size: 0.875rem;
            margin-top: 5px;
            display: none;
        }

        .field-error.show {
            display: block;
        }

        .field-help {
            font-size: 0.8rem;
            color: #6c757d;
            margin-top: 3px;
        }

        .loading-container {
            text-align: center;
            padding: 60px 20px;
        }

        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-container {
            text-align: center;
            padding: 40px 20px;
            color: #721c24;
        }

        .error-container i {
            font-size: 3rem;
            color: #dc3545;
            margin-bottom: 20px;
        }

        .error-container h3 {
            margin-bottom: 10px;
            color: #721c24;
        }

        .error-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .form-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
            }

            .form-group.full-width {
                grid-column: span 1;
            }

            .form-actions {
                justify-content: center;
            }

            .error-actions {
                flex-direction: column;
                align-items: center;
            }
        }

        /* Image section styles */
        #activity-afbeeldingen {
            padding-top: 10px;
        }

        .image-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .image-picture {
            max-width: 50px;
            max-height: 50px;
        }
    </style>

    <script>
        const token = sessionStorage.getItem("JWT");
        const API_URL = '/api/activiteit';
        let currentActivity = null;
        let isEditMode = false;
        let retryCount = 0;
        const MAX_RETRIES = 3;
        let newActivityImages = []; // Store images for new activities

        // Validation rules
        const validationRules = {
            naam: { required: true, minLength: 2, maxLength: 255 },
            locatie: { required: true, minLength: 2, maxLength: 255 },
            omschrijving: { required: true, minLength: 10, maxLength: 2000 },
            begin: { required: true },
            eind: { required: true },
            kost: { required: false, min: 0, max: 9999.99 },
            max: { required: true, min: 1, max: 1000 },
            min: { required: true, min: 1, max: 1000 },
            // afbeelding: { required: false, pattern: /^https?:\/\/.+\.(jpg|jpeg|png|gif|webp)(\?.*)?$/i }
        };

        // Helper functions
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function getActivityIdFromUrl() {
            const m = window.location.pathname.match(/\/beheerder\/activiteiten\/(\d+)\/edit/);
            if (m) return parseInt(m[1]);
            const urlParams = new URLSearchParams(window.location.search);
            const id = urlParams.get('id');
            return id ? parseInt(id) : null;
        }

        function goBack() {
            if (document.referrer && document.referrer.includes('/beheerder/')) {
                window.history.back();
            } else {
                window.location.href = '/beheerder/activiteiten';
            }
        }

        // Validation functions
        function clearAllErrors() {
            document.querySelectorAll('.field-error').forEach(error => {
                error.classList.remove('show');
                error.textContent = '';
            });
            document.querySelectorAll('input, textarea').forEach(field => {
                field.classList.remove('error');
            });
        }

        function showFieldError(fieldId, message) {
            const field = document.getElementById(fieldId);
            const errorElement = document.getElementById(fieldId.replace('activity-', '') + '-error');

            if (field) field.classList.add('error');
            if (errorElement) {
                errorElement.textContent = message;
                errorElement.classList.add('show');
            }
        }

        function validateField(fieldId, value) {
            const fieldName = fieldId.replace('activity-', '');
            const rules = validationRules[fieldName];

            if (!rules) return true;

            // Required validation
            if (rules.required && (!value || (typeof value === 'string' && value.trim() === ''))) {
                showFieldError(fieldId, `${fieldName.charAt(0).toUpperCase() + fieldName.slice(1)} is verplicht`);
                return false;
            }

            // Skip other validations if field is not required and empty
            if (!rules.required && (!value || (typeof value === 'string' && value.trim() === ''))) {
                return true;
            }

            // String validations
            if (typeof value === 'string') {
                if (rules.minLength && value.length < rules.minLength) {
                    showFieldError(fieldId, `Minimaal ${rules.minLength} karakters vereist`);
                    return false;
                }
                if (rules.maxLength && value.length > rules.maxLength) {
                    showFieldError(fieldId, `Maximaal ${rules.maxLength} karakters toegestaan`);
                    return false;
                }
                // if (rules.pattern && !rules.pattern.test(value)) {
                //     showFieldError(fieldId, 'Ongeldig formaat (verwacht: geldige afbeelding URL)');
                //     return false;
                // }
            }

            // Number validations
            if (typeof value === 'number') {
                if (rules.min !== undefined && value < rules.min) {
                    showFieldError(fieldId, `Minimale waarde is ${rules.min}`);
                    return false;
                }
                if (rules.max !== undefined && value > rules.max) {
                    showFieldError(fieldId, `Maximale waarde is ${rules.max}`);
                    return false;
                }
            }

            return true;
        }

        function validateForm() {
            clearAllErrors();

            const formData = getFormData();
            let isValid = true;

            // Validate each field
            for (const [key, value] of Object.entries(formData)) {
                if (!validateField('activity-' + key, value)) {
                    isValid = false;
                }
            }

            // Custom cross-field validation
            if (formData.min > formData.max) {
                showFieldError('activity-min', 'Minimum kan niet groter zijn dan maximum');
                showFieldError('activity-max', 'Maximum kan niet kleiner zijn dan minimum');
                isValid = false;
            }

            // Date validation
            const beginDate = new Date(formData.begin);
            const eindDate = new Date(formData.eind);
            const now = new Date();

            if (beginDate <= now && !isEditMode) {
                showFieldError('activity-begin', 'Begin datum moet in de toekomst liggen');
                isValid = false;
            }

            if (beginDate >= eindDate) {
                showFieldError('activity-eind', 'Eind datum moet na begin datum liggen');
                isValid = false;
            } else {
                // Calculate duration more precisely
                const durationMs = eindDate - beginDate;
                const durationHours = Math.floor(durationMs / (1000 * 60 * 60));
                const durationDays = Math.floor(durationMs / (1000 * 60 * 60 * 24));

                // Check maximum duration (3 days = 72 hours)
                // if (durationHours > 72) {
                //     const daysOver = Math.floor((durationHours - 72) / 24);
                //     showFieldError('activity-eind', `Activiteit duurt te lang (${durationDays} dagen). Maximaal 3 dagen (72 uur) toegestaan`);
                //     isValid = false;
                // }

                // Check minimum duration (15 minutes)
                if (durationMs < 15 * 60 * 1000) {
                    showFieldError('activity-eind', 'Activiteit moet minimaal 15 minuten duren');
                    isValid = false;
                }
            }

            return isValid;
        }

        function getFormData() {
            const kostValue = document.getElementById('activity-kost').value.trim();
            return {
                naam: document.getElementById('activity-naam').value.trim(),
                locatie: document.getElementById('activity-locatie').value.trim(),
                eten: document.getElementById('activity-eten').checked ? 1 : 0,
                omschrijving: document.getElementById('activity-omschrijving').value.trim(),
                begin: document.getElementById('activity-begin').value,
                eind: document.getElementById('activity-eind').value,
                kost: kostValue === '' ? 0 : parseFloat(kostValue) || 0,
                max: parseInt(document.getElementById('activity-max').value),
                min: parseInt(document.getElementById('activity-min').value),
                // afbeelding: document.getElementById('activity-afbeelding').value.trim()
            };
        }

        // Loading and error handling
        function retryLoad() {
            const activityId = getActivityIdFromUrl();
            if (activityId && retryCount < MAX_RETRIES) {
                retryCount++;
                document.getElementById('error-message').style.display = 'none';
                document.getElementById('loading').style.display = 'block';
                loadActivity(activityId);
            } else {
                showError('Maximaal aantal pogingen bereikt. Probeer later opnieuw.');
            }
        }

        function showError(message = 'Er is een fout opgetreden bij het laden van de activiteit.') {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('activity-form').style.display = 'none';
            document.getElementById('error-text').textContent = message;
            document.getElementById('error-message').style.display = 'block';
        }

        // Main functions
        document.addEventListener('DOMContentLoaded', function() {
            const activityId = getActivityIdFromUrl();

            if (activityId) {
                isEditMode = true;
                document.getElementById('page-title').textContent = 'Activiteit Bewerken';
                document.getElementById('submit-btn').textContent = 'Bijwerken';
                document.title = 'Activadis - Activiteit Bewerken';
                loadActivity(activityId);
            } else {
                // New activity mode
                isEditMode = false;
                document.getElementById('loading').style.display = 'none';
                document.getElementById('activity-form').style.display = 'block';

                // Set default values for new activity
                const now = new Date();
                const tomorrow = new Date(now.getTime() + 24 * 60 * 60 * 1000);
                const threeLater = new Date(tomorrow.getTime() + 3 * 60 * 60 * 1000); // 3 hours later

                // Set minimum date/time to current time for both fields
                const minDateTime = now.toISOString().slice(0, 16);
                document.getElementById('activity-begin').min = minDateTime;
                document.getElementById('activity-eind').min = minDateTime;

                document.getElementById('activity-begin').value = tomorrow.toISOString().slice(0, 16);
                document.getElementById('activity-eind').value = threeLater.toISOString().slice(0, 16);

                // Initialize image display for new activity
                displayNewActivityImages();
            }

            // Add real-time validation
            document.querySelectorAll('#activity-form input, #activity-form textarea').forEach(field => {
                field.addEventListener('blur', function() {
                    const fieldName = this.id.replace('activity-', '');
                    if (validationRules[fieldName]) {
                        let value = this.value;
                        if (this.type === 'number') {
                            value = parseFloat(value);
                        }
                        validateField(this.id, value);
                    }
                });
                
                field.addEventListener('input', function() {
                    // Clear error when user starts typing
                    this.classList.remove('error');
                    const errorElement = document.getElementById(this.id.replace('activity-', '') + '-error');
                    if (errorElement) {
                        errorElement.classList.remove('show');
                    }
                });
            });

            // Handle form submission
            document.getElementById('activity-form').addEventListener('submit', handleSubmit);

            // Add date validation to prevent manual entry of past dates
            const beginDateInput = document.getElementById('activity-begin');
            const endDateInput = document.getElementById('activity-eind');

            function validateDateInput(input, fieldId) {
                const inputDate = new Date(input.value);
                const now = new Date();

                if (input.value && inputDate < now && !isEditMode) {
                    input.value = now.toISOString().slice(0, 16);
                    showFieldError(fieldId, 'Datum kan niet in het verleden liggen');
                    setTimeout(() => {
                        const errorElement = document.getElementById(fieldId.replace('activity-', '') + '-error');
                        if (errorElement) {
                            errorElement.classList.remove('show');
                        }
                    }, 3000);
                }
            }

            beginDateInput.addEventListener('change', function() {
                validateDateInput(this, 'activity-begin');
                // Update minimum end time when begin time changes
                const beginTime = this.value;
                if (beginTime) {
                    endDateInput.min = beginTime;

                    // If end time is before begin time, update it to match begin time
                    if (endDateInput.value && endDateInput.value <= beginTime) {
                        endDateInput.value = beginTime;
                    }
                }
            });

            endDateInput.addEventListener('change', function() {
                validateDateInput(this, 'activity-eind');
                // Also check that end time is after begin time
                const beginTime = beginDateInput.value;
                const endTime = this.value;

                if (beginTime && endTime && new Date(endTime) <= new Date(beginTime)) {
                    // Set end time to exactly the same as begin time
                    this.value = beginTime;
                    showFieldError('activity-eind', 'Eindtijd aangepast naar begintijd');
                    setTimeout(() => {
                        const errorElement = document.getElementById('eind-error');
                        if (errorElement) {
                            errorElement.classList.remove('show');
                        }
                    }, 3000);
                }
            });
        });

        async function loadActivity(id) {
            if (!id) {
                showError('Geen activiteit ID gevonden.');
                return;
            }

            try {
                const response = await fetch(`${API_URL}?id=${id}&token=${token}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    if (response.status === 401) {
                        showError('U bent niet geautoriseerd. Log opnieuw in.');
                        setTimeout(() => window.location.href = '/login', 2000);
                        return;
                    } else if (response.status === 404) {
                        showError('Activiteit niet gevonden.');
                        return;
                    } else {
                        throw new Error(`HTTP ${response.status}`);
                    }
                }

                const activity = await response.json();
                
                if (!activity || (Array.isArray(activity) && activity.length === 0)) {
                    showError('Activiteit niet gevonden.');
                    return;
                }
                
                // Handle both single object and array responses
                const activityData = Array.isArray(activity) ? 
                    activity.find(act => act.id == id) : activity;
                
                if (activityData) {
                    currentActivity = activityData;
                    populateForm(activityData);
                } else {
                    showError('Activiteit niet gevonden.');
                }
                
            } catch (error) {
                console.error('Error loading activity:', error);
                const errorMessage = retryCount < MAX_RETRIES ? 
                    'Fout bij laden van activiteit. Probeer het opnieuw.' : 
                    'Kan activiteit niet laden na meerdere pogingen.';
                showError(errorMessage);
            }
        }

        function populateForm(activity) {
            try {
                console.log('Data = ', activity);

                document.getElementById('activity-naam').value = activity.naam || '';
                document.getElementById('activity-locatie').value = activity.locatie || '';
                document.getElementById('activity-eten').checked = Boolean(activity.eten);
                document.getElementById('activity-omschrijving').value = activity.omschrijving || '';
                
                // Handle date formatting safely - preserve local time, avoid timezone conversion
                if (activity.begin) {
                    const beginDate = new Date(activity.begin);
                    if (!isNaN(beginDate.getTime())) {
                        // Format date as YYYY-MM-DDTHH:MM without timezone conversion
                        const year = beginDate.getFullYear();
                        const month = String(beginDate.getMonth() + 1).padStart(2, '0');
                        const day = String(beginDate.getDate()).padStart(2, '0');
                        const hours = String(beginDate.getHours()).padStart(2, '0');
                        const minutes = String(beginDate.getMinutes()).padStart(2, '0');
                        document.getElementById('activity-begin').value = `${year}-${month}-${day}T${hours}:${minutes}`;
                    }
                }
                
                if (activity.eind) {
                    const eindDate = new Date(activity.eind);
                    if (!isNaN(eindDate.getTime())) {
                        // Format date as YYYY-MM-DDTHH:MM without timezone conversion
                        const year = eindDate.getFullYear();
                        const month = String(eindDate.getMonth() + 1).padStart(2, '0');
                        const day = String(eindDate.getDate()).padStart(2, '0');
                        const hours = String(eindDate.getHours()).padStart(2, '0');
                        const minutes = String(eindDate.getMinutes()).padStart(2, '0');
                        document.getElementById('activity-eind').value = `${year}-${month}-${day}T${hours}:${minutes}`;
                    }
                }
                
                document.getElementById('activity-kost').value = activity.kost || '';
                document.getElementById('activity-max').value = activity.max || '';
                document.getElementById('activity-min').value = activity.min || '';
                // document.getElementById('activity-afbeelding').value = activity.afbeelding || '';

                if(activity.afbeeldingen[0] == null){
                    document.getElementById('activity-afbeeldingen').innerHTML = '<p>Geen afbeelding toegevoegd.</p>';
                }else{
                    document.getElementById('activity-afbeeldingen').innerHTML = "";

                    activity.afbeeldingen.forEach(afbeelding => {
                        document.getElementById('activity-afbeeldingen').innerHTML += `
                            <div class="image-item">
                                <img src="${afbeelding.afbeeldingUrl}" alt="activiteit afbeelding" class="image-picture">
                                <p>${afbeelding.afbeeldingUrl}</p>
                                <button type="button" onClick="removeImage(event, '${afbeelding.id}')">X</button>
                            </div>
                        `;
                    })
                }
                
                // Show form and hide loading
                document.getElementById('loading').style.display = 'none';
                document.getElementById('activity-form').style.display = 'block';
                
            } catch (error) {
                console.error('Error populating form:', error);
                showError('Fout bij het vullen van het formulier.');
            }

        }

        async function handleSubmit(e) {
            e.preventDefault();
            
            if (!validateForm()) {
                // Scroll to first error
                const firstError = document.querySelector('.field-error.show');
                if (firstError) {
                    firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
                return;
            }

            const formData = getFormData();
            
            if (isEditMode && currentActivity) {
                formData.id = currentActivity.id;
                formData.hidden = currentActivity.hidden || 0; // Preserve hidden status
            }

            const submitBtn = document.getElementById('submit-btn');
            const originalText = submitBtn.textContent;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class=\"fas fa-spinner fa-spin\"></i> Bezig...';

            try {
                const response = await fetch(`${API_URL}?token=${token}`, {
                    method: isEditMode ? 'PUT' : 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(errorText || `HTTP ${response.status}`);
                }

                if (isEditMode) {
                    // No response expected for PUT request
                    // Show success message
                    alert('Activiteit succesvol bijgewerkt!');

                    // Redirect after short delay to allow user to see success
                    setTimeout(() => {
                        window.location.href = '/beheerder/activiteiten.html';
                    }, 500);
                } else {
                    const result = await response.json();
                    console.log('Activity creation response:', result);
                    const newActivityId = result; // The result IS the insertId directly

                    console.log('New activity created with ID:', newActivityId);

                    // Now add all images to the new activity
                    if (newActivityImages.length > 0) {
                        console.log('Adding images to new activity:', newActivityImages);

                        for (const imageData of newActivityImages) {
                            try {
                                console.log('Saving image to database:', imageData.url, 'for activity ID:', newActivityId);

                                const imageResponse = await fetch(`/api/afbeelding?token=${token}`, {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json'
                                    },
                                    body: JSON.stringify({
                                        activiteitId: newActivityId,
                                        afbeeldingUrl: imageData.url
                                    })
                                });

                                if (!imageResponse.ok) {
                                    const errorText = await imageResponse.text();
                                    console.error('Failed to add image:', imageData.url, 'Status:', imageResponse.status, 'Error:', errorText);
                                } else {
                                    const imageResult = await imageResponse.json();
                                    console.log('Image successfully saved to database:', imageResult);
                                }
                            } catch (imageError) {
                                console.error('Error adding image:', imageError, 'URL:', imageData.url);
                            }
                        }
                    }

                    // Show success message
                    alert('Activiteit succesvol toegevoegd!');
                    
                    // Redirect after short delay to allow user to see success
                    setTimeout(() => {
                        window.location.href = '/beheerder/activiteiten';
                    }, 500);
                }
                
            } catch (error) {
                console.error('Error saving activity:', error);
                let errorMessage = 'Er is een fout opgetreden bij het opslaan.';
                
                // Parse the actual server error message
                if (error.message.includes('required fields') || error.message.includes('missing')) {
                    errorMessage = 'Niet alle verplichte velden zijn correct ingevuld: ' + error.message;
                } else if (error.message.includes('Unauthorized')) {
                    errorMessage = 'U bent niet geautoriseerd. Log opnieuw in.';
                    setTimeout(() => window.location.href = '/login', 2000);
                } else if (error.message.includes('Database error')) {
                    errorMessage = 'Database fout opgetreden. Probeer het later opnieuw.';
                } else if (error.message.includes('400')) {
                    errorMessage = 'Ongeldige gegevens. Controleer uw invoer.';
                } else if (error.message.includes('500')) {
                    errorMessage = 'Server fout opgetreden. Probeer het later opnieuw.';
                } else if (error.message.trim() !== '') {
                    // Use the actual error message from the server
                    errorMessage = error.message;
                }
                
                alert(errorMessage);
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
            }
        }

        async function removeImage(event, afbeeldingId) {
            event.preventDefault();

            console.log('Removing image with ID:', afbeeldingId);

            // Show confirmation dialog
            if (!confirm('Weet je zeker dat je deze afbeelding wilt verwijderen?')) {
                return;
            }

            try {
                const response = await fetch(`/api/afbeelding?id=${afbeeldingId}&token=${token}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    if (response.status === 401) {
                        alert('U bent niet geautoriseerd. Log opnieuw in.');
                        setTimeout(() => window.location.href = '/login', 2000);
                        return;
                    } else {
                        throw new Error(`HTTP ${response.status}`);
                    }
                }

                console.log('Image successfully deleted');

                // Remove the image from the UI
                const imageElement = event.target.closest('div');
                if (imageElement) {
                    imageElement.remove();
                }

            } catch (error) {
                console.error('Error deleting image:', error);
            }
        }

        async function addImage(event) {
            if (event) {
                event.preventDefault();
            }

            const afbeeldingUrlInput = document.getElementById('activity-afbeeldingUrl');
            const afbeeldingUrl = afbeeldingUrlInput.value.trim();

            console.log("Adding image URL:", afbeeldingUrl);

            // Validate input
            if (!afbeeldingUrl) {
                alert('Voer een afbeelding URL in.');
                return;
            }

            // Basic URL validation
            try {
                new URL(afbeeldingUrl);
            } catch (error) {
                alert('Voer een geldige URL in.');
                return;
            }

            if (isEditMode && currentActivity) {
                // For editing existing activities, add directly to database
                const activiteitId = currentActivity.id;

                try {
                    const response = await fetch(`/api/afbeelding?token=${token}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            activiteitId: activiteitId,
                            afbeeldingUrl: afbeeldingUrl
                        })
                    });

                    if (!response.ok) {
                        if (response.status === 401) {
                            alert('U bent niet geautoriseerd. Log opnieuw in.');
                            setTimeout(() => window.location.href = '/login', 2000);
                            return;
                        } else {
                            throw new Error(`HTTP ${response.status}`);
                        }
                    }

                    const result = await response.json();
                    console.log('Image successfully added:', result);

                    // Clear the input field
                    afbeeldingUrlInput.value = '';

                    // Add the new image to the UI
                    const imageContainer = document.getElementById('activity-afbeeldingen');

                    // Clear any 'geen afbeelding' text if it exists
                    const noImageText = imageContainer.querySelector('p');
                    if (noImageText && noImageText.textContent.includes('Geen afbeelding')) {
                        imageContainer.innerHTML = '';
                    }

                    const newImageDiv = document.createElement('div');
                    newImageDiv.className = 'image-item';
                    newImageDiv.innerHTML = `
                        <img src="${afbeeldingUrl}" alt="activiteit afbeelding" class="image-picture" onerror="this.style.display='none';">
                        <p>${afbeeldingUrl}</p>
                        <button type="button" onClick="removeImage(event, '${result}')">X</button>
                    `;
                    imageContainer.appendChild(newImageDiv);

                } catch (error) {
                    console.error('Error adding image:', error);
                    alert('Er is een fout opgetreden bij het toevoegen van de afbeelding.');
                }
            } else {
                // For new activities, store in array and display
                const imageData = {
                    url: afbeeldingUrl,
                    tempId: Date.now() + Math.random() // Temporary ID for removal
                };

                newActivityImages.push(imageData);

                // Clear the input field
                afbeeldingUrlInput.value = '';

                // Update the display
                displayNewActivityImages();

                console.log('Image added to new activity array:', newActivityImages);
            }
        }

        function displayNewActivityImages() {
            const imageContainer = document.getElementById('activity-afbeeldingen');

            if (newActivityImages.length === 0) {
                imageContainer.innerHTML = '<p>Geen afbeeldingen toegevoegd.</p>';
                return;
            }

            imageContainer.innerHTML = '';
            newActivityImages.forEach(imageData => {
                const newImageDiv = document.createElement('div');
                newImageDiv.className = 'image-item';
                newImageDiv.innerHTML = `
                    <img src="${imageData.url}" alt="activiteit afbeelding" class="image-picture" onerror="this.style.display='none';">
                    <p>${imageData.url}</p>
                    <button type="button" onClick="removeNewActivityImage('${imageData.tempId}')">X</button>
                `;
                imageContainer.appendChild(newImageDiv);
            });
        }

        // Make this function globally accessible
        window.removeNewActivityImage = function(tempId) {
            // Remove from array
            newActivityImages = newActivityImages.filter(img => img.tempId != tempId);

            // Update display
            displayNewActivityImages();

            console.log('Image removed from new activity array:', newActivityImages);
        }
    </script>
</body>
</html>