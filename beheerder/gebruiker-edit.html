<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/header.css">
    <script src="/beheerder/verifyAdmin.js"></script>
    <title>Activadis - Gebruiker Bewerken</title>
</head>
<body>
<header>
    <div class="container">
        <div class="left">
            <p><b><span class="accent">Acti</span>vadis</b>: Gebruiker Bewerken</p>
            <nav>
                <div class="nav-left">
                    <a href="/"><i class="fas fa-home"></i>Home</a>
                    <a href="/beheerder">Beheerder</a>
                </div>
                <div>
                    <a class="login" href="/login"><i class="fas fa-sign-in-alt"></i>Login</a>
                    <p class="logout name">NAME HERE</p>
                    <a class="logout" onclick="logout()">Logout</a>
                </div>
            </nav>
        </div>
    </div>
</header>
    <section id="mainContainer">
        <aside id="sidebar">
            <h1>Navigatie</h1>
            <ul>
                <li><a href="/beheerder/index.html">Dashboard</a></li>
                <li><a href="/beheerder/gebruikers.html">Gebruikers</a></li>
                <li><a href="/beheerder/activiteiten.html">Activiteiten</a></li>
            </ul>
        </aside>
        <main id="mainContent">
            <div class="heading split-row">
                <h2 id="page-title">Nieuwe Gebruiker</h2>
                <button class="btn btn-secondary" onclick="goBack()">
                    <i class="fas fa-arrow-left"></i> Terug
                </button>
            </div>

            <div id="user-form-section" class="content-section">
                <div id="loading">
                    <p>Laden...</p>
                </div>
                <form id="user-form" style="display: none;">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="user-firstname">Voornaam *</label>
                            <input type="text" id="user-firstname" required>
                        </div>
                        <div class="form-group">
                            <label for="user-lastname">Achternaam *</label>
                            <input type="text" id="user-lastname" required>
                        </div>
                        <div class="form-group full-width">
                            <label for="user-email">Email *</label>
                            <input type="email" id="user-email" required>
                            <p id="user-email-error" class="text-danger" style="display:none; font-size: 0.9em; margin-top: 5px;"></p>
                        </div>
                        <div class="form-group" id="password-reset-group" style="display: none;">
                            <label>Wachtwoord beheer</label>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <button type="button" class="btn btn-warning btn-small" id="reset-password-btn" onclick="togglePasswordReset()">
                                    <i class="fas fa-key"></i> Wachtwoord Resetten
                                </button>
                                <span id="reset-status" style="display: none; color: #dc3545; font-weight: bold;">
                                    <i class="fas fa-exclamation-triangle"></i> Wachtwoord wordt gereset bij opslaan
                                </span>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="user-admin">Rol *</label>
                            <select id="user-admin" required>
                                <option value="2">Gebruiker</option>
                                <option value="1">Admin</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="goBack()">Annuleren</button>
                        <button type="submit" class="btn btn-primary" id="submit-btn">Toevoegen</button>
                    </div>
                </form>
                <div id="error-message" style="display: none;">
                    <p class="text-danger">Fout bij het laden van de gebruiker.</p>
                    <button class="btn btn-secondary" onclick="goBack()">Terug naar overzicht</button>
                </div>
            </div>
        </main>
    </section>

    <style>
        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        .form-group.full-width {
            grid-column: span 2;
        }
        
        .form-group label {
            font-weight: bold;
            margin-bottom: 5px;
            color: #333;
        }
        
        .form-group input,
        .form-group textarea,
        .form-group select {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 2px rgba(0,123,255,.25);
        }
        
        .form-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }
        
        .text-danger {
            color: #dc3545;
        }
        
        .btn-small {
            padding: 5px 10px;
            font-size: 12px;
        }
        
        #reset-status {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .form-group.full-width {
                grid-column: span 1;
            }
        }
    </style>

    <script>
        const token = sessionStorage.getItem("JWT");
        const API_URL = '/api/gebruiker';
        let currentUser = null;
        let isEditMode = false;
        let passwordResetRequested = false;

        // Helper functions for text handling
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Get user ID from URL parameters
        function getUserIdFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('id');
        }

        // Go back to previous page or users list
        function goBack() {
            if (document.referrer && document.referrer.includes('/beheerder/')) {
                window.history.back();
            } else {
                window.location.href = '/beheerder/gebruikers.html';
            }
        }

        // Toggle password reset request
        function togglePasswordReset() {
            passwordResetRequested = !passwordResetRequested;
            const btn = document.getElementById('reset-password-btn');
            const status = document.getElementById('reset-status');
            
            if (passwordResetRequested) {
                btn.innerHTML = '<i class="fas fa-undo"></i> Annuleren Reset';
                btn.className = 'btn btn-danger btn-small';
                status.style.display = 'inline';
            } else {
                btn.innerHTML = '<i class="fas fa-key"></i> Wachtwoord Resetten';
                btn.className = 'btn btn-warning btn-small';
                status.style.display = 'none';
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            const userId = getUserIdFromUrl();
            if (userId) {
                isEditMode = true;
                document.getElementById('page-title').textContent = 'Gebruiker Bewerken';
                document.getElementById('submit-btn').textContent = 'Bijwerken';
                document.getElementById('password-reset-group').style.display = 'block';
                document.title = 'Activadis - Gebruiker Bewerken';
                loadUser(userId);
            } else {
                // New user mode
                isEditMode = false;
                document.getElementById('loading').style.display = 'none';
                document.getElementById('user-form').style.display = 'block';
            }

            // Handle form submission
            document.getElementById('user-form').addEventListener('submit', handleSubmit);
        });

        async function loadUser(id) {
            try {
                const response = await fetch(`${API_URL}?id=${id}&token=${token}`);
                
                if (response.ok) {
                    const users = await response.json();
                    // API returns array, find the specific user
                    const user = Array.isArray(users) ? 
                        users.find(usr => usr.id == id) : users;
                    
                    if (user) {
                        currentUser = user;
                        populateForm(user);
                    } else {
                        showError();
                    }
                } else {
                    showError();
                }
            } catch (error) {
                console.error('Error loading user:', error);
                showError();
            }
        }

        function populateForm(user) {
            document.getElementById('user-firstname').value = user.firstname || '';
            document.getElementById('user-lastname').value = user.lastname || '';
            document.getElementById('user-email').value = user.email || '';
            document.getElementById('user-admin').value = user.admin ? '1' : '2';
            
            // Show form and hide loading
            document.getElementById('loading').style.display = 'none';
            document.getElementById('user-form').style.display = 'block';
        }

        async function handleSubmit(e) {
            e.preventDefault();
            
            const firstname = document.getElementById('user-firstname').value.trim();
            const lastname = document.getElementById('user-lastname').value.trim();
            const email = document.getElementById('user-email').value.trim();
            const password = passwordResetRequested;
            const role = parseInt(document.getElementById('user-admin').value);

            // Reset previous error messages
            const emailErrorEl = document.getElementById('user-email-error');
            if (emailErrorEl) {
                emailErrorEl.style.display = "none";
                emailErrorEl.textContent = "";
            }

            // Validate fields
            if (!firstname || !lastname) {
                alert('Voornaam en achternaam zijn verplicht!');
                return;
            }

            if (!email) {
                if (emailErrorEl) {
                    emailErrorEl.textContent = "Email is verplicht!";
                    emailErrorEl.style.display = "block";
                } else {
                    alert('Email is verplicht!');
                }
                return;
            }

            // Email validation
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                if (emailErrorEl) {
                    emailErrorEl.textContent = "Voer een geldig e-mailadres in!";
                    emailErrorEl.style.display = "block";
                } else {
                    alert('Voer een geldig e-mailadres in!');
                }
                return;
            }

            // Confirm password reset if requested
            if (passwordResetRequested && isEditMode) {
                if (!confirm('Weet je zeker dat je het wachtwoord van deze gebruiker wilt resetten? De gebruiker krijgt automatisch een nieuw wachtwoord toegestuurd per email.')) {
                    return;
                }
            }

            // Pre-check for duplicate emails on the frontend
            try {
                const users = await fetch(`${API_URL}?token=${token}`).then(res => res.json());
                if (users.some(u => {
                    if (isEditMode && currentUser) {
                        if (u.id !== currentUser.id) {
                            return u.email.toLowerCase() === email.toLowerCase();
                        }
                    } else {
                        return u.email.toLowerCase() === email.toLowerCase();
                    }
                    return false;
                })) {
                    if (emailErrorEl) {
                        emailErrorEl.textContent = "Dit e-mailadres is al in gebruik!";
                        emailErrorEl.style.display = "block";
                    } else {
                        alert('Dit e-mailadres is al in gebruik!');
                    }
                    return;
                }
            } catch (err) {
                console.warn("Kon gebruikers niet vooraf controleren:", err);
            }

            // Build request payload
            const formData = { email, role, firstname, lastname };
            if (isEditMode && currentUser) {
                formData.id = currentUser.id;
                formData.reset = password;
            }

            // Disable submit button to prevent double submission
            const submitBtn = document.getElementById('submit-btn');
            const originalText = submitBtn.textContent;
            submitBtn.disabled = true;
            submitBtn.textContent = 'Bezig...';

            try {
                const response = await fetch(`${API_URL}?token=${token}`, {
                    method: isEditMode ? 'PUT' : 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });

                if (response.ok) {
                    let message = isEditMode ? 'Gebruiker bijgewerkt!' : 'Gebruiker toegevoegd!';
                    if (passwordResetRequested && isEditMode) {
                        message += '\n\nHet wachtwoord is gereset en de gebruiker ontvangt een nieuwe inloglink per email.';
                    }
                    alert(message);
                    
                    // Redirect to users list
                    window.location.href = '/beheerder/gebruikers.html';
                } else {
                    const error = await response.text();
                    if (error.includes("Email is already in use") && emailErrorEl) {
                        emailErrorEl.textContent = "Dit e-mailadres is al in gebruik!";
                        emailErrorEl.style.display = "block";
                    } else {
                        alert('Fout: ' + error);
                    }
                }
            } catch (error) {
                console.error('Error saving user:', error);
                alert('Fout bij opslaan van gebruiker');
            } finally {
                // Re-enable submit button
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
            }
        }

        function showError() {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('error-message').style.display = 'block';
        }
    </script>
</body>
</html>