<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/header.css">
    <script src="/beheerder/verifyAdmin.js"></script>
    <title>Activadis - Beheerder</title>
</head>
<body>
    <header>
        <div class="container">
            <div class="left">
                <p><b><span class="accent">Acti</span>vadis</b>: Beheerder</p>
                <nav>
                    <div class="nav-left">
                        <a href="/"><i class="fas fa-home"></i>Home</a>
                        <a href="/beheerder" class="active">Beheerder</a>
                    </div>
                    <div>
                        <a class="login" href="/login"><i class="fas fa-sign-in-alt"></i>Login</a>
                        <p class="logout name"></p>
                        <a class="logout" onclick="logout()">Logout</a>
                    </div>
                </nav>
            </div>
        </div>
    </header>
    <section id="mainContainer">
        <aside id="sidebar">
            <h1>Navigatie</h1>
            <ul>
                <li><a href="/beheerder/" class="active">Dashboard</a></li>
                <li><a href="/beheerder/gebruikers">Gebruikers</a></li>
                <li><a href="/beheerder/activiteiten">Activiteiten</a></li>
            </ul>
        </aside>
        <main id="mainContent">
            <div class="heading split-row">
                <h2>Dashboard</h2>
            </div>
            <div id="dashboard-stats">
                <h3><i class="fas fa-chart-bar"></i> Insights</h3>
                <div id="stats-container">
                    <div>
                        <div><i class="fas fa-calendar-alt"></i> Activiteiten</div>
                        <span id="activiteiten-count">-</span>
                    </div>
                    <div>
                        <div><i class="fas fa-users"></i> Gebruikers</div>
                        <span id="gebruikers-count">-</span>
                    </div>
                    <div>
                        <div><i class="fas fa-clipboard-list"></i> Inschrijvingen</div>
                        <span id="inschrijvingen-count">-</span>
                    </div>
                    <div>
                        <div><i class="fas fa-box"></i> Benodigdheden</div>
                        <span id="benodigdheden-count">-</span>
                    </div>
                </div>
            </div>

            <div id="recent-activities" class="content-section">
                <h3>Recente Activiteiten</h3>
                <ul id="activiteiten-list"></ul>
            </div>

            <hr class="section-separator thick">

            <div id="manage-section">
                <div class="manage-block">
                    <div class="heading split-row">
                        <h3>Activiteiten</h3>
                        <button class="btn btn-primary btn-small" onclick="window.location.href='/beheerder/activiteiten/new'">
                            <i class="fas fa-plus"></i> Nieuwe Activiteit
                        </button>
                    </div>
                    
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th><i class="fas fa-calendar-check"></i> Naam</th>
                                <th><i class="fas fa-map-marker-alt"></i> Locatie</th>
                                <th><i class="fas fa-calendar"></i> Datum</th>
                                <th><i class="fas fa-euro-sign"></i> Kosten</th>
                                <th class="justify-right">Acties</th>
                            </tr>
                        </thead>
                        <tbody id="all-activiteiten-list">
                        </tbody>
                    </table>
                </div>

                <hr class="section-separator">

                <div class="manage-block">
                    <div class="heading split-row">
                        <h3>Gebruikers</h3>
                        <button class="btn btn-primary btn-small" onclick="window.location.href='/beheerder/gebruikers/new'">
                            <i class="fas fa-plus"></i> Nieuwe Gebruiker
                        </button>
                    </div>
                    
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th><i class="fas fa-envelope"></i> Email</th>
                                <th><i class="fas fa-user-tag"></i> Rol</th>
                                <th class="justify-right">Acties</th>
                            </tr>
                        </thead>
                        <tbody id="all-gebruikers-list">
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </section>

    <script type="module">
        import {
            Notification,
            NotifType,
        } from "../../util/notif.js";

        const token = sessionStorage.getItem("JWT");

        // API Base URLs
        const API = {
            activiteit: '/api/activiteit',
            gebruiker: '/api/gebruiker',
            inschrijving: '/api/inschrijving',
            benodigdheid: '/api/benodigdheid'
        };

        // Helper functions for text handling
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatTextWithNewlines(text) {
            if (!text) return '';
            return escapeHtml(text).replace(/\n/g, '<br>');
        }

        // Load dashboard data on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadDashboard();
        });

        async function loadDashboard() {
            try {
                // Load all data
                const [activiteiten, gebruikers, inschrijvingen, benodigdheden] = await Promise.all([
                    fetch(API.activiteit + "?token=" + token).then(res => res.json()),
                    fetch(API.gebruiker + "?token=" + token).then(res => res.json()),
                    fetch(API.inschrijving + "?token=" + token).then(res => res.json()),
                    fetch(API.benodigdheid + "?token=" + token).then(res => res.json())
                ]);

                // Update counters
                document.getElementById('activiteiten-count').textContent = activiteiten.length;
                document.getElementById('gebruikers-count').textContent = gebruikers.length;
                document.getElementById('inschrijvingen-count').textContent = inschrijvingen.length;
                document.getElementById('benodigdheden-count').textContent = benodigdheden.length;

                // Display recent activities
                displayRecentActiviteiten(activiteiten.slice(0, 5));

                // Display all activities for management
                displayAllActiviteiten(activiteiten);

                // Display all users for management
                displayAllGebruikers(gebruikers);

            } catch (error) {
                console.error('Error loading dashboard:', error);
            }
        }

        function displayRecentActiviteiten(activiteiten) {
            const list = document.getElementById('activiteiten-list');
            list.innerHTML = '';

            activiteiten.forEach(act => {
                const li = document.createElement('li');
                li.innerHTML = `
                    <strong>${escapeHtml(act.naam)}</strong> - ${escapeHtml(act.locatie)}
                    (${new Date(act.begin).toLocaleDateString()})
                `;
                list.appendChild(li);
            });
        }

        function displayAllActiviteiten(activiteiten) {
            const tbody = document.getElementById('all-activiteiten-list');
            tbody.innerHTML = '';

            activiteiten.forEach(act => {
                const row = document.createElement('tr');
                row.style.cursor = 'pointer';
                row.onclick = function() {
                    window.location.href = `/beheerder/activiteiten/${act.id}`;
                };
                
                const beginDate = new Date(act.begin);
                
                row.innerHTML = `
                    <td><strong>${escapeHtml(act.naam)}</strong></td>
                    <td>${escapeHtml(act.locatie)}</td>
                    <td>${beginDate.toLocaleDateString()}</td>
                    <td>â‚¬${act.kost}</td>
                    <td onclick="event.stopPropagation()">
                        <div class="justify-right" style="display: flex; gap: 5px; flex-wrap: wrap;">
                            <button class="btn btn-primary btn-small" onclick="window.location.href='/beheerder/activiteiten/${act.id}/edit'">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-danger btn-small" onclick="deleteActiviteit(${act.id})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function displayAllGebruikers(gebruikers) {
            const tbody = document.getElementById('all-gebruikers-list');
            tbody.innerHTML = '';

            gebruikers.forEach(user => {
                const row = document.createElement('tr');
                row.style.cursor = 'pointer';
                row.onclick = function() {
                    window.location.href = `/beheerder/gebruikers/${user.id}`;
                };
                
                row.innerHTML = `
                    <td>${user.email}</td>
                    <td>${(user.isAdmin === 1 || user.isAdmin === true) ? 'Admin' : 'Gebruiker'}</td>
                    <td onclick="event.stopPropagation()">
                        <div class="justify-right" style="display: flex; gap: 5px; flex-wrap: wrap;">
                            <button class="btn btn-primary btn-small" onclick="window.location.href='/beheerder/gebruikers/${user.id}/edit'">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-danger btn-small" onclick="deleteGebruiker(${user.id})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        window.deleteActiviteit = async (id) => {
            if (confirm('Weet je zeker dat je deze activiteit wilt verwijderen?')) {
                try {
                    const response = await fetch(`${API.activiteit}?id=${id}&token=${token}`, {
                        method: 'DELETE'
                    });

                    if (response.ok) {
                        const notification = new Notification("Activiteit verwijderd.", NotifType.SUCCESS);
                        notification.show();
                        loadDashboard(); // Refresh data
                    } else {
                        const notification = new Notification("Error deleting activiteit.", NotifType.ERROR);
                        notification.show();
                    }
                } catch (error) {
                    console.error('Error deleting activiteit:', error);
                    const notification = new Notification("Error deleting activiteit.", NotifType.ERROR);
                    notification.show();
                }
            }
        }

        window.deleteGebruiker = async (id) => {
            if (confirm('Weet je zeker dat je deze gebruiker wilt verwijderen?')) {
                try {
                    const response = await fetch(`${API.gebruiker}?id=${id}&token=${token}`, {
                        method: 'DELETE'
                    });

                    if (response.ok) {
                        const notification = new Notification("Gebruiker verwijderd.", NotifType.SUCCESS);
                        notification.show();
                        loadDashboard(); // Refresh data
                    } else {
                        const notification = new Notification("Error deleting gebruiker.", NotifType.ERROR);
                        notification.show();
                    }
                } catch (error) {
                    console.error('Error deleting gebruiker:', error);
                    const notification = new Notification("Error deleting gebruiker.", NotifType.ERROR);
                    notification.show();
                }
            }
        }
    </script>
</body>
</html>